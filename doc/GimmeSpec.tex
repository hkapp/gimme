\documentclass[10pt,a4paper]{article}

\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[left=1in,right=1in,top=1in,bottom=1in]{geometry}

\newcommand{\gimme}{\textsf{gimme}}

\title{Gimme:\\ A simple versioning system for shared folders}

\begin{document}
\maketitle

\section{Introduction}

We present here \gimme, a simple versioning system for shared folders. It uses an assymetric model, in which one of the parties acts as the "master" or "real truth", and the other is a dirty local copy.

\subsection{Possible names}

The names to be used to reference the two parties involved are not fixed yet. Possible pairs include :
\begin{itemize}
\item master version vs local copy
\item truth vs dirty copy
\item remote vs local
\item shared vs local
\item accepted version vs pending changes
\end{itemize}

\section{Model}

We describe here the model used by \gimme{}.

\subsection{Master version vs local copy}

\gimme{} uses an assymetric model, where one of the two parties involved acts as a "master", and the other is seen as a local copy.

The master version holds the shared truth for all the systems. It holds all the information, in the latest \textit{accepted} state. Information (conceptually speaking) should never disappear from the master version. its goal is to aggregate all the information present on all the systems.

The local copy is a working directory for a single machine. Files can be modified, copied, added, removed, etc... without affecting the master version. In this case, the copy is called \textit{dirty}.

Changes to the local copy are shared with all systems by calling \gimme. These changes then become part of the shared truth. We say these changes are \textit{accepted}. This is called an \textit{upload}, or \textit{update}.

The other way around, changes that are part of the shared truth but are not present in the local copy are also synchronized upon calling \gimme. This process is called \textit{download} or \textit{upgrade}.

\subsection{Subscription model}

One of the big differences between the master version and local copies is that local copies do not necessarily have all the information, and maybe they do not want it.

We model this using \textit{subscriptions}. Local copies explicitely subscribe to a specific set of folders and files. A local copy is not interested in updates or removal of folders or files it does not subscribe to. When a new folder or file is added in a folder that the local copy is subscribed to, the user it prompted to know whether this copy should subscribe to this new element.

It is still unclear what the exact granularity of subscriptions is. It should be possible to choose which folders to subscribe to, and which not too. There could be a mechanism to tell that a folder is subscribed to all its (future) content. This can be bound to the folder, or only to the current update.

The only reason to have a granularity at the level of single files would be to allow deleting a file locally because it is not necessary, but keeping it in the master version. That use-case seems very obscure. When speaking about music files, a similar result can be achieved by removing the file from the library.

To subscribe, the folder only needs to be present in the local copy. New folders added in the master version can be proposed for copy in the local copy, but this process should not be the default. It is always possible to copy a folder from the master file system to subscribe to it.

To unsubscribe, the folder needs to be deleted on the local copy. Then, when computing the changelog, the user should tell explicitely that this deletion is an unsubscribe, and should not be reflected in the master version. There is no default between the two behaviours, the choice must be made explicit anyway.

\subsection{Data considered}

We consider folders and files.

\subsection{Possible actions}

For a given element (either file or folder), the possible actions can be :
\begin{enumerate}
\item Add
\item Delete
\item Update
\end{enumerate}

Note that folders can only be updated if their content has been modified (any of the changes listed above).

\section{The synchronization process}

We describe here the different steps that must be performed when synchronizing two devices.

\subsection{Workflow}

\subsection{Computing the changelogs}

\subsection{State machine}

\newcommand{\logstate}[1]{\textsc{#1}}
\newcommand{\sub}[0]{\logstate{sub}}
\newcommand{\unsub}[0]{\logstate{unsub}}
\newcommand{\subrm}[0]{\logstate{rm}}
\newcommand{\track}[0]{\logstate{add}}
\newcommand{\trackrm}[0]{\logstate{rm}}

\newcommand{\physstate}[1]{\textsc{#1}}
\newcommand{\same}[0]{\physstate{sam}}
\newcommand{\modif}[0]{\physstate{upd}}
\newcommand{\present}[0]{\physstate{add}}
\newcommand{\absent}[0]{\physstate{rm}}

\newcommand{\action}[1]{\textsf{#1}}
\newcommand{\donothing}{\action{nothing}}
\newcommand{\cpfile}{\action{cp}}
\newcommand{\cplatest}{\action{latest}}
\newcommand{\metaupd}{\action{upd-hash}}
\newcommand{\rmfile}{\action{rm}}

\begin{table}
	\makebox[\textwidth][c]{
	\begin{tabular}{r | c c c |}
local \textbackslash{} master & (\track, \same) & (\track, \modif) & (\track, \absent) \\
\hline
(\sub, \same) 
& (\sub, \donothing, \track, \donothing) & (\sub, \cpfile, \track, \metaupd) & (\subrm, \rmfile, \trackrm, \donothing)
\\
(\sub, \modif)
& (\sub, \metaupd, \track, \cpfile) & (\sub, \cplatest, \track, \cplatest) & $^1$[\sub, \track] / [\subrm, \trackrm]
\\
(\sub, \absent)
& $^2$[\unsub, \track] / [\subrm, \trackrm] & $^2$[\unsub, \track] / [\subrm, \trackrm] & (\subrm, \donothing, \trackrm, \donothing)
\\
\hline
(\unsub, \present)
& (\sub, \cplatest, \track, \cplatest) & (\sub, \cplatest, \track, \cplatest) & $^1$[\sub, \track] / [\subrm, \trackrm]
\\
(\unsub, \absent)
& (\unsub, \donothing, \track, \donothing) & (\unsub, \donothing, \track, \metaupd) & (\subrm, \donothing, \trackrm, \donothing)
\\
\hline
	\end{tabular}
}
	\caption{State machine for tracked files}
\end{table}

\begin{table}
	\makebox[\textwidth][c]{
	\begin{tabular}{r | c c |}
local \textbackslash{} master & (\trackrm, \present) & (\trackrm, \absent) \\
\hline
(\subrm, \present)
& (\sub, \cplatest, \track, \cplatest) & (\sub, \metaupd, \track, \cpfile) \\
(\subrm, \absent)
& $^3$[\sub, \track] / [\unsub, \track] & (\subrm, \donothing, \trackrm, \donothing) \\
\hline
	\end{tabular}
}
	\caption{State machine for untracked files}
\end{table}

\subsection{Simple merge}

\subsection{Merge conflicts}

\begin{tabular}{l|c c c c}
 & Add & Update & Delete & Unsubscribe \\
\hline
Add & \ref{addadd} &\\
Update & & \ref{updupd} & \ref{upddel} &\\
Delete & \ref{deladd} & \ref{delupd} & \\
\end{tabular}

\subsubsection{Master delete and local update}
\label{delupd}

\subsubsection{Master delete and local add}
\label{deladd}

Folder subscribed to or not before ?

\subsubsection{Master add and local delete}
\label{adddel}

\subsubsection{Master update and local delete}
\label{upddel}

Unsubscribe, except if on file

\subsubsection{Master add and local add}
\label{addadd}

\subsubsection{Master update and local update}
\label{updupd}

\section{Commit}

\subsection{Commit point}

\subsection{Elements part of the commit / changelog}

\end{document}